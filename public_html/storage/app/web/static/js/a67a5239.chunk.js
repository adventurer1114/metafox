"use strict";(self.webpackChunk_metafox_react=self.webpackChunk_metafox_react||[]).push([["composer"],{84820:function(e,t,a){a.r(t),a.d(t,{default:function(){return C}});var n=a(37166),o=a(85597),i=a(76224),r=a(13478),l=a(50130),s=a(38790),c=a(86010),d=a(9041),m=a(67294),p={editorControls:[{as:"commentComposer.control.attachEmoji"},{as:"commentComposer.control.attachFile",showWhen:["and",["falsy","editing"],["falsy","previewFiles"]]},{as:"chatComposer.control.buttonSubmit"}]},u=a(22410),f=a(73327),g=(0,u.Z)(e=>(0,f.Z)({root:{width:"100%"},composeOuter:{display:"flex",padding:e.spacing(.5,.5,.5,2),minHeight:e.spacing(4.25),alignItems:"center",overflowY:"auto",height:"100%"},"composeOuter-dense":{padding:e.spacing(.5)},composeInner:{flex:1,minWidth:0},composeInputWrapper:{width:"100%",flexFlow:"wrap",display:"flex",alignItems:"center"},expand:{"& $composeInputWrapper":{flex:"none",width:"100%"}},composer:{maxHeight:"200px",overflowY:"auto",minHeight:0,flex:1,flexBasis:"auto",minWidth:0,display:"flex"," & .DraftEditor-root":{width:"100%"},"& .public-DraftEditorPlaceholder-root":{position:"absolute",color:e.palette.text.secondary,fontSize:e.mixins.pxToRem(15)},"& .DraftEditor-editorContainer":{minWidth:e.spacing(2),fontSize:e.mixins.pxToRem(15)},"& .mentionSuggestionsWrapper":{position:"absolute",zIndex:1,minWidth:180,backgroundColor:e.mixins.backgroundColor("paper"),borderRadius:4,padding:e.spacing(1),marginTop:e.spacing(1),boxShadow:"0px 10px 13px -6px rgba(0,0,0,0.2), 0px 20px 31px 3px rgba(0,0,0,0.14)"},"& .mentionText":{color:e.palette.primary.main},"& .hashtagStyle":{color:e.palette.primary.main}},attachIconsWrapper:{display:"inline-flex",alignItems:"flex-end",padding:"0 2px",marginLeft:"auto","& .ico-smile-o":{fontSize:e.mixins.pxToRem(15)}},attachBtn:{padding:0,display:"inline-flex",alignItems:"center",justifyContent:"center",width:e.spacing(3.5),height:e.spacing(3.5),minWidth:e.spacing(3.5),color:e.palette.text.secondary},attachBtnIcon:{fontSize:"14px"},extraDataPhoto:{maxWidth:e.spacing(26)},extraDataSticker:{width:e.spacing(10),height:e.spacing(10)},cancelBtn:{fontSize:"small",color:e.palette.text.secondary,marginLeft:e.spacing(5),marginBottom:e.spacing(1),"& span":{color:e.palette.primary.main}}}),{name:"ChatCompose"}),h=a(81719);let x=(0,h.ZP)(l.Z)(({theme:e})=>({padding:0,display:"inline-flex",alignItems:"center",justifyContent:"center",width:e.spacing(3.5),height:e.spacing(3.5),minWidth:e.spacing(3.5),color:e.palette.text.secondary})),y=(0,h.ZP)(i.zb)(({theme:e})=>({fontSize:e.spacing(1.75)}));var v=m.forwardRef(function({title:e,icon:t,onClick:a,testid:n},o){return m.createElement(s.Z,{title:e},m.createElement(x,{onClick:a,size:"small",ref:o,"data-testid":n,role:"button"},m.createElement(y,{icon:t})))}),C=m.forwardRef(function({rid:e,msgId:t,text:a="",focus:u,reactMode:f,onCancel:h,extra_data:x,onSuccess:y,onMarkAsRead:C,margin:E="normal",previewRef:S},w){let k=g(),{i18n:b,dispatch:I,jsxBackend:F}=(0,o.OgA)(),[W,K]=m.useState(d.EditorState.createWithContent((0,d.convertFromRaw)((0,r.DK)((0,r.s9)(a||""))))),[_,B]=m.useState("sticker"===(null==x?void 0:x.extra_type)?x.extra_id:void 0),[O,z]=m.useState("photo"===(null==x?void 0:x.extra_type)?x.extra_id:void 0),[P,R]=m.useState(!1),T=null==x?void 0:x.full_path,Z=m.useRef(),[M,D]=m.useState([]),N=e=>{let t=e.getCurrentContent(),a=t.getBlockMap(),n=a.last().getKey(),o=a.last().getLength(),i=new d.SelectionState({anchorKey:n,anchorOffset:o,focusKey:n,focusOffset:o});return i};m.useEffect(()=>{if("edit"===f){let e=d.ContentState.createFromText(a),t=d.EditorState.createWithContent(e);K(d.EditorState.forceSelection(t,N(t))),setImmediate(()=>{Q()})}},[a,f,e]);let L=m.useCallback(()=>{let e=W.getCurrentContent(),t=e.getFirstBlock(),a=e.getLastBlock(),n=new d.SelectionState({anchorKey:t.getKey(),anchorOffset:0,focusKey:a.getKey(),focusOffset:a.getLength(),hasFocus:!0}),o=d.EditorState.push(W,d.Modifier.removeRange(e,n,"backward"),"remove-range");K(o)},[W]),j=m.useMemo(()=>{return{onSuccess:()=>{L(),R(!1),"function"==typeof y&&y()}}},[L]),H=m.useMemo(()=>{return{editing:"edit"===f,previewFiles:M.length}},[f,M]),[G,U,Y]=(0,o.sgG)(p,H),$=b.formatMessage({id:"write_message"}),A=t=>{I({type:"chat/composer/SUBMIT",payload:{rid:e,sticker_id:t},meta:j})},q=()=>{var e;null===(e=S.current)||void 0===e||e.clear(),D([]),L(),R(!1),"no_react"!==f&&y()},J=()=>{R(!1)},Q=m.useCallback(()=>{C&&C(),setImmediate(()=>Z.current.focus())},[e]),V=()=>{let a=W.getCurrentContent().getPlainText();a&&a.trim()&&!P&&(R(!0),I({type:"chat/composer/SUBMIT",payload:{reactMode:f,rid:e,msgId:t,text:a.trim(),sticker_id:_,photo_id:O},meta:j}))},X=e=>{return!e.keyCode||13!==e.keyCode||e.metaKey||e.shiftKey||e.altKey||e.ctrlKey?(0,d.getDefaultKeyBinding)(e):"composer-submit"},ee=a=>{if("composer-submit"===a){if(M&&M.length&&Object.values(M).length){let n=W.getCurrentContent().getPlainText();if(P)return;R(!0),I({type:"chat/composer/upload",payload:{files:Object.values(M),rid:e,text:n,reactMode:f,msgId:t},meta:{onSuccess:q,onFailure:J}})}else V();return"handled"}return"not-handled"};(0,m.useEffect)(()=>{u&&Q()},[u,Q]),(0,m.useEffect)(()=>{let e=e=>{h&&27===e.keyCode&&h()};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[]),m.useImperativeHandle(w,()=>{return{attachFiles:e=>{(null==e?void 0:e.length)&&D(e)},removeFile:e=>{let t=[...M];e>-1&&(t.splice(e,1),D([...t]))}}});let et=m.useMemo(()=>{let e=W.getCurrentContent().getPlainText(),t=e&&e.trim();return!!(!P&&(null==M?void 0:M.length)||t)},[M,W,P]),ea=e=>{if(e.length&&S&&S.current){let t=e[0];if((0,r.rO)(t.type)){var a;D([...M,t]),null===(a=S.current)||void 0===a||a.attachFiles([...M,t])}}};return m.createElement("form",{className:k.root,role:"presentation","data-testid":"chatComposerForm"},m.createElement("div",{className:(0,c.default)(k.composeOuter,k[`composeOuter-${E}`])},m.createElement("div",{className:k.composeInner},m.createElement("div",{className:k.composeInputWrapper},m.createElement("div",{className:k.composer,onClick:Q,"data-testid":"draftEditor"},m.createElement(n.ZP,{stripPastedStyles:!0,ref:Z,plugins:G,placeholder:$,editorState:W,keyBindingFn:X,handleKeyCommand:ee,onChange:K,handlePastedFiles:ea}),F.render(U)),m.createElement("div",{className:k.attachIconsWrapper},Y.map(t=>F.render({component:t.as,props:{key:t.as,classes:k,previewRef:S,filesUploadRef:w,onStickerClick:A,control:v,editorRef:Z,rid:e,disableSubmit:et,handleSubmit:()=>ee("composer-submit")}})))))),"edit"===f&&0<O?m.createElement("div",null,m.createElement("div",{className:k.extraDataPhoto},m.createElement(i.Gy,{src:T,alt:"photo"})),m.createElement(s.Z,{title:b.formatMessage({id:"remove"})},m.createElement(l.Z,{onClick:()=>z(void 0)},m.createElement(i.zb,{icon:"ico-close"})))):null,"edit"===f&&0<_?m.createElement("div",null,m.createElement("div",{className:k.extraDataSticker},m.createElement(i.Gy,{src:T,alt:"sticker",aspectRatio:"fixed",imageFit:"contain"})),m.createElement(s.Z,{title:b.formatMessage({id:"remove"})},m.createElement(l.Z,{onClick:()=>B(void 0)},m.createElement(i.zb,{icon:"ico-close"})))):null)})}}]);